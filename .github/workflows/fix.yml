name: Run-Fixes

on:
  pull_request:
    branches: [main]
  

jobs:
  Pipeline-Scan:
    runs-on: [ubuntu-latest]
    steps:
      - name: checkout code
        uses: actions/checkout@v4.1.3

      - name: Setup Veracode
        run: |
         curl -fsS https://tools.veracode.com/veracode-cli/install | sh

      - name: Package App
        run: |
         ./veracode package -s . --output verascan -a

      - name: SAST Scan
        continue-on-error: true
        env:
         VERACODE_API_KEY_ID: ${{ secrets.VERACODE_API_ID }}
         VERACODE_API_KEY_SECRET: ${{ secrets.VERACODE_API_KEY }}
        run: |
         ./veracode static scan ./verascan/veracode-auto-pack-verademo-python-python.zip --summary-output sast-summary.txt
      
      - name: Upload SAST issues artifact
        uses: actions/upload-artifact@v4.3.3
        with:
           name: results.json
           path: "./results.json"

  Fix-Flaws:
    needs: Pipeline-Scan
    runs-on: [ubuntu-latest]
    permissions: write-all
    steps:
      - name: checkout code
        uses: actions/checkout@v4.1.3

      - name: setup node
        uses: actions/setup-node@v4
        with: 
          node-version: '20.19.3'


      - name: Upload flaws artifact
        uses: actions/download-artifact@v4
        with:
          name: results.json

      - name: Create fixes from static findings
        id: convert
        uses: Veracode/veracode-fix@main
        with:
          vid: ${{ secrets.VERACODE_API_ID }}
          vkey: ${{ secrets.VERACODE_API_KEY }}
          inputFile: results.json
          source_base_path_1: "verademo-python/:"
          # source_base_path_2: "WEB-INF:src/main/webapp/WEB-INF"
          language: python
          cwe: 89 # SQL Injection
          fixType: 'batch'
          debug: false
          prComment: true
          files: 'all'
          codeSuggestion: false
          createPR: true
          #token: ${{ secrets.PAT_TOKEN_SUPREME }}

           
